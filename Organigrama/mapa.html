<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa MTTO LAV ESTE</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üü¢</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        header h1, header h2, header a {
            font-family: 'Montserrat', sans-serif;
        }
        header {
            background: linear-gradient(180deg, #E0F2F1, #E6F5F5); /* Gradiente vertical de verde muy claro a azul muy claro */
            color: #333; /* Color de texto oscuro por defecto para mejor contraste */
            padding: 20px; /* A√±adir padding */
            text-align: center; /* Centrar texto */
        }

        header h1, header a {
            font-family: 'Montserrat', sans-serif;
            color: white; /* T√≠tulo principal en blanco */
        }

        header h2 {
            font-family: 'Montserrat', sans-serif;
            color: #cccccc; /* Subt√≠tulo en gris claro */
        }
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        #map {
            height: 650px;
            width: 100%;
            z-index: 0;
            border: none;
            position: relative;
        }
        
        .office-icon {
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, box-shadow;
        }
        
        .office-icon:not(.bm-icon) {
            background: linear-gradient(135deg, #1976D2 0%, #0D47A1 100%);
        }
        
        .office-icon.bm-icon {
            background: linear-gradient(135deg, #008080 0%, #006633 100%);
        }
        
        .office-icon:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            background: linear-gradient(135deg, #2196F3 0%, #1565C0 100%);
        }
        
        .office-icon:hover {
            transform: translateY(-2px) scale(1.1);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .reset-view-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: #008080;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            z-index: 2;
            transition: background-color 0.3s;
        }

        .reset-view-button:hover {
            background-color: #005293;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 16px;
            width: 90%;
            max-width: 1000px; /* Aumentado el ancho m√°ximo */
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            transform: translateY(-20px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border: 1px solid rgba(0,128,128,0.1);
            padding: 24px;
        }
        
        .modal-overlay.active .modal-card {
            transform: translateY(0) scale(1);
        }
        
        .cluster-number {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #1976D2 0%, #0D47A1 100%);
            color: white;
            font-size: 10px;
            padding: 2px 3px;
            border-radius: 50%;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
 
        .cluster-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            color: #333;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            pointer-events: none;
        }

        .leaflet-control-attribution {
            display: none !important;
        }

        .cluster-label span {
            display: inline-block;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .iframe-container {
            width: 100%;
            height: 200px;
            overflow: hidden;
            border-radius: 8px;
            margin-top: 8px;
        }

        .modal-title {
            background: linear-gradient(135deg, #008080 0%, #00a8a8 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0, 128, 128, 0.2);
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #666;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .close-btn:hover {
            color: #008080;
            transform: rotate(90deg);
        }
        
        .puesto-item {
            border-bottom: 1px solid rgba(0,128,128,0.1);
            padding: 12px 20px; /* Ajustar padding */
            margin: 0 20px 12px 20px; /* Ajustar margen inferior */
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: #e8f5e9; /* Fondo verde claro para la tarjeta */
            border-left: 4px solid #008080; /* Borde izquierdo verde azulado oscuro */
            border-radius: 8px;
        }
        
        .puesto-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .puesto-header {
            margin-bottom: 8px;
        }
        
        .nombres-list {
            margin-left: 20px;
        }
        
        .persona-icon {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .persona-icon.adif {
            background-color: #008080;
            color: white;
        }
        
        .persona-icon.ineco {
            background-color: #0066cc;
            color: white;
        }
        
        .nombre-item {
            padding: 4px 0;
            display: flex;
            align-items: center;
        }

        .nombre-item span {
            color: #333; /* Aplicar color de texto oscuro a los nombres en todos los modales */
        }
        
        .persona-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            font-size: 0.8rem;
        }
        
        .persona-icon.ineco {
            background-color: #2196F3;
            color: white;
        }
        
        .persona-icon.adif {
            background-color: #008080;
            color: white;
        }
        
        .person-item a {
            color: #008080;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .person-item a:hover {
            color: #2196F3;
            transform: translateX(2px);
        }
        
        .logo-adif {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 120px;
            height: auto;
            z-index: 20;
        }
        
        .logo-ineco {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 120px;
            height: auto;
            z-index: 20;
        }
        
        .adif-logo {
            background-image: url('https://www.adifaltavelocidad.es/documents/34745/2553140/Logo_Adif_AV_verde_351x170.png/aa356add-9b30-836e-8d9f-276eb02d17cf?t=1617203111419&download=true');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .ineco-logo {
            background-image: url('https://www.ineco.com/ineco/sites/default/files/2022-12/Logo%20Ineco.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        .location-header {
            background: linear-gradient(90deg, rgba(0,82,147,1) 0%, rgba(0,128,128,1) 100%);
            color: white;
            transition: all 0.3s ease;
        }
        
        .location-header:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .map-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-top: 5px;
            width: 100%;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            border: 2px solid #666;
        }
        
        .footer {
            margin-top: 20px;
            padding: 15px 20px;
            text-align: center;
            font-size: 0.9rem;
            background: linear-gradient(90deg, rgba(0,82,147,1) 0%, rgba(0,128,128,1) 100%);
            color: white;
            border-top: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .footer-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }
        
        .footer-item {
            margin: 0;
            color: white;
            font-weight: 500;
        }
        
        /* Estilos espec√≠ficos para modales de oficinas */
        .office-modal-content .puesto-item {
            border-left: 4px solid #008080; /* Borde izquierdo verde azulado oscuro */
            background-color: #e3f2fd; /* Fondo azul claro */
            padding: 12px 20px; /* Ajustar padding */
        }

        .office-modal-content .puesto-header span {
            color: #1565C0; /* Color de texto azul oscuro para el puesto */
        }

        .office-modal-content .nombre-item span {
            color: #333; /* Color de texto m√°s oscuro para el nombre */
        }
        @media (max-width: 768px) {
            .header {
                top: 10px;
                left: 10px;
                right: 10px;
                padding: 10px 15px;
            }
            
            .header h1 {
                font-size: 1.2rem;
            }
            
            .person-label {
                min-width: 80px;
            }
        }
    </style>
    <style>
        /* Estilo para el icono junto al t√≠tulo en el modal */
        .modal-title-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px; /* Ajustar tama√±o del icono */
            height: 24px; /* Ajustar tama√±o del icono */
            border-radius: 50%;
            background-color: #2E7D32; /* Color verde oscuro */
            color: white;
            font-size: 0.9rem; /* Ajustar tama√±o del icono */
            margin-right: 8px; /* Espacio a la derecha del icono */
        }

        /* Estilos espec√≠ficos para modales de oficinas */
        .office-modal-content .puesto-item {
            border-left: 4px solid #2196F3; /* Borde izquierdo azul para diferenciar */
            background-color: #e3f2fd; /* Fondo azul claro */
            padding: 12px 20px; /* Ajustar padding */
        }

        .office-modal-content .puesto-header span {
            color: #1565C0; /* Color de texto azul oscuro para el puesto */
        }

        .office-modal-content .nombre-item span {
            color: #333; /* Color de texto m√°s oscuro para el nombre */
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-4 relative">
        <header class="mb-4 text-center relative z-10">
            <!-- Logo ADIF -->
            <img src="https://www.adifaltavelocidad.es/documents/34745/2553140/Logo_Adif_AV_verde_351x170.png/aa356add-9b30-836e-8d9f-276eb02d17cf?t=1617203111419&download=true" alt="ADIF" class="logo-adif absolute top-0 left-0 w-48">
            <!-- Logo INECO -->
            <img src="https://www.ineco.com/ineco/sites/default/files/2022-12/Logo%20Ineco.png" alt="INECO" class="logo-ineco absolute top-0 right-0 w-44 h-21.5 mt-2">
            <a href="#" class="text-5xl font-bold text-[#005293] mb-2 hover:text-[#008080] transition-colors">MANTENIMIENTO LAV ESTE </a>
            <h2 class="text-3xl font-semibold text-[#008080]">Distribuci√≥n Geogr√°fica</h2>
            <div class="w-24 h-1 bg-[#008080] mx-auto mt-4 rounded-full"></div>
        </header>
 
        <div class="bg-white shadow-lg rounded-lg p-4 mb-4 border border-gray-300">
            <div class="flex justify-center">
                <div class="flex gap-4">
                    <button onclick="window.location.href='index.html'" class="px-4 py-2 bg-[#008080] text-white rounded-md hover:bg-[#005293] transition-colors">
                        üë©‚Äçüë©‚Äçüëß‚Äçüëß ORGANIGRAMA
                    </button>
                    <button onclick="window.location.href='directorio.html'" class="px-4 py-2 bg-[#008080] text-white rounded-md hover:bg-[#005293] transition-colors">
                       üìû DIRECTORIO
                    </button>
                    <!-- Bot√≥n PREGUNTAME a√±adido aqu√≠ -->
                    <button onclick="window.location.href='preguntame.html'" class="px-4 py-2 bg-[#008080] text-white rounded-md hover:bg-[#005293] transition-colors">
                        ü§ñ ESTE-LA
                    </button>
                </div>
            </div>
        </div>

    </div>
    
    <div class="map-container relative">
        <div id="map"></div>
        <button class="reset-view-button" id="resetView">Vista EJE ESTE</button>
    </div>

    <div class="footer">
        <div class="footer-content">
            <p class="footer-item">¬© 2025 Mantenimiento LAV ESTE</p>
        </div>
    </div>
    
    <div class="modal-overlay" id="modal">
        <div class="modal-card bg-white rounded-lg shadow-xl">
            <button class="close-btn" id="closeModal"><i class="fas fa-times"></i></button>
            <div class="p-6">
                <h2 class="text-2xl font-semibold text-[#2196F3] mb-4" id="modal-title">Centro de Trabajo</h2>
                <div class="space-y-4" id="modal-content">
                    <!-- Personas se insertar√°n aqu√≠ -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Cargar datos desde el archivo JSON
        fetch('./unified_data.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.json();
            })
            .then(centros => {
                // Inicializar el mapa
                const map = L.map('map');
                // Ajustar el zoom inicial del navegador
                document.body.style.zoom = '90%';
                
                // A√±adir capa base del mapa con l√≠mites provinciales
                const baseMap = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
                    attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors | Tiles: &copy; <a href="https://hot.openstreetmap.org/">Humanitarian OpenStreetMap Team</a>'
                }).addTo(map);

                // A√±adir capa de l√≠mites provinciales
                const provinceBoundaries = L.tileLayer('https://{s}.tile.openstreetmap.fr/data/osmborder/{z}/{x}/{y}.json', {
                    attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors | Province boundaries: &copy; <a href="https://osmfr.github.io/osmborder/">OSM Border</a>'
                }).addTo(map);

                // A√±adir capa de transporte
                const transportMap = L.tileLayer('https://{s}.tile.openstreetmap.fr/transport/{z}/{x}/{y}.png', {
                    attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors | Map style: &copy; <a href="https://openstreetmap.fr">OpenStreetMap France</a>'
                }).addTo(map);

                // A√±adir capa de ferrocarriles de alta velocidad
                const railwayMap = L.tileLayer('https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png', {
                    attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors | Map style: &copy; <a href="https://www.OpenRailwayMap.org">OpenRailwayMap</a>'
                }).addTo(map);

                // A√±adir leyenda en la esquina superior derecha
                const legend = L.control({position: 'topright'});
                legend.onAdd = function (map) {
                    const div = L.DomUtil.create('div', 'info legend');
                    div.innerHTML = `
                        <div class="bg-white p-2 rounded-lg shadow-md flex items-center gap-2">
                            <span class="w-4 h-1 bg-red-600"></span>
                            <span class="text-gray-700">LAV (L√≠nea de Alta Velocidad)</span>
                        </div>
                    `;
                    // Ajustar el padding para que est√© en la esquina superior derecha
                    div.style.padding = '12px 12px 0 12px';
                    return div;
                };
                legend.addTo(map);
                legend.addTo(map);

                // Establecer vista inicial en Madrid con zoom 12
                map.setView([40.4165, -3.7026], 12);

                // Crear un grupo de marcadores con clustering personalizado
                const markers = L.markerClusterGroup({
                    maxClusterRadius: 40, // Radio m√°ximo del cluster
                    showCoverageOnHover: false,
                    spiderfyOnMaxZoom: true,
                    disableClusteringAtZoom: 15, // Deshabilitar clustering a partir del zoom 15
                    iconCreateFunction: function(cluster) {
                        const childCount = cluster.getChildCount();
                        const icon = L.divIcon({
                            html: '<div class="cluster-icon">' +
                                  '<i class="fas fa-building"></i>' +
                                  '<span class="cluster-number">' + childCount + '</span>' +
                                  '</div>',
                            className: 'office-icon',
                            iconSize: [32, 32],
                            iconAnchor: [16, 16]
                        });
                        return icon;
                    }
                });

                // Crear marcadores para cada centro
                centros.forEach(centro => {
                    let lat = centro.lat;
                    let lon = centro.lon;
                    
                    // Crear marcador
                    const marker = L.marker([lat, lon], {
                        icon: createOfficeIcon(centro.id_centro.startsWith('BM'))
                    });

                    // A√±adir etiqueta con el nombre
                    marker.bindTooltip(centro.nombre_centro, {
                        permanent: true,
                        direction: 'bottom',
                        className: 'cluster-label',
                        offset: [0, 20]
                    });

                    // A√±adir popup con informaci√≥n del centro
                    marker.bindPopup(centro.nombre_centro);

                    // A√±adir el marcador al grupo de clustering
                    markers.addLayer(marker);
                });

                // A√±adir el grupo de marcadores al mapa
                map.addLayer(markers);

                // Ajustar el zoom para que todos los marcadores est√©n visibles
                map.fitBounds(markers.getBounds(), {
                    padding: [20, 20]
                });

                // Guardar la vista inicial
                const initialView = {
                    bounds: markers.getBounds(),
                    zoom: map.getZoom()
                };

                // Crear icono personalizado para los centros
                function createOfficeIcon(isBM = false) {
                    return L.divIcon({
                        className: 'office-icon' + (isBM ? ' bm-icon' : ''),
                        html: isBM ? '<i class="fas fa-tools"></i>' : '<i class="fas fa-building"></i>',
                        iconSize: [28, 28],
                        iconAnchor: [14, 14]
                    });
                }

                // Asociar datos del centro al marcador y manejar clic
                markers.eachLayer((marker) => {
                    // Buscar el centro correspondiente
                    const centro = centros.find(c => 
                        c.lat === marker.getLatLng().lat && 
                        c.lon === marker.getLatLng().lng
                    );

                    // Verificar que se encontr√≥ el centro
                    if (!centro) {
                        console.error('Centro no encontrado para estas coordenadas:', marker.getLatLng());
                        return;
                    }

                    // Asignar los datos al marcador
                    marker.centroData = centro;

                    // Crear el popup
                    marker.bindPopup(`<div class="p-4">
                        <h3 class="text-lg font-semibold mb-2">${centro.nombre_centro}</h3>
                        <p class="text-gray-600">${centro.personas.length} personas</p>
                    </div>`);

                    // Manejar el clic
                    marker.on('click', function(e) {
                        if (marker.centroData) {
                            openModal(marker.centroData);
                        } else {
                            console.error('Datos del centro no disponibles');
                        }
                    });
                });

                // Funci√≥n para restablecer la vista inicial
                const resetButton = document.getElementById('resetView');
                if (resetButton) {
                    resetButton.addEventListener('click', () => {
                        map.fitBounds(markers.getBounds(), {
                            padding: [20, 20]
                        });
                    });
                }

                // Elementos del modal
                const modal = document.getElementById('modal');
                const modalTitle = document.getElementById('modal-title');
                const modalContent = document.getElementById('modal-content');
                const closeModalBtn = document.getElementById('closeModal');

                // Funci√≥n para abrir el modal con los datos del centro
                function openModal(centro) {
                    console.log('Abriendo modal para centro:', centro); // Log para depuraci√≥n
                    if (!centro) {
                        console.error('Centro no v√°lido');
                        return;
                    }

                    modalTitle.innerHTML = `
                        <div class="modal-title">
                            <span>${centro.nombre_centro}</span>
                        </div>
                    `;
                    modalContent.innerHTML = '';
                    
                    // Agrupar personas por puesto si existen
                    const personasPorPuesto = {};
                    if (centro.personas && Array.isArray(centro.personas) && centro.personas.length > 0) {
                        centro.personas.forEach(persona => {
                            if (persona && persona.puesto) { // Cambiado de persona.cargo a persona.puesto
                                const puesto = persona.puesto.trim(); // Cambiado de cargo a puesto
                                if (!personasPorPuesto[puesto]) { // Cambiado de cargo a puesto
                                    personasPorPuesto[puesto] = [];
                                }
                                if (persona.nombre) {
                                    personasPorPuesto[puesto].push(persona); // Guardar el objeto completo de la persona
                                }
                            }
                        });
                    }

                    console.log('Personas agrupadas por puesto:', personasPorPuesto); // Log para depuraci√≥n

                    // Verificar si hay informaci√≥n para mostrar
                    const hasPersonas = Object.keys(personasPorPuesto).length > 0;
                    const hasInfo = centro.direccion || centro.ambitos_mantenimiento || centro.horario || centro.contacto;
                    
                    // Si no hay informaci√≥n ni personas, mostrar mensaje
                    if (!hasPersonas && !hasInfo) {
                        const noInfoDiv = document.createElement('div');
                        noInfoDiv.className = 'text-center py-4 text-gray-500';
                        noInfoDiv.textContent = 'No hay informaci√≥n disponible para este centro.';
                        modalContent.appendChild(noInfoDiv);
                        return;
                    }

                    // Determinar si es BM u oficina
                    const isBM = centro.nombre_centro.includes('BM');
                    
                    // Crear la estructura de dos columnas para BM o una columna para oficinas
                    const container = document.createElement('div');
                    
                    if (isBM && hasPersonas) {
                        container.className = 'flex flex-col md:flex-row gap-8';
                        
                        // Columna izquierda: Informaci√≥n general (solo para BM)
                        const infoColumn = document.createElement('div');
                        infoColumn.className = 'w-full md:w-1/2 space-y-6';

                        // Agregar video para BM Monforte, imagen para otros
                        if (centro.nombre_centro === 'BM Monforte') {
                            const videoDiv = document.createElement('div');
                            videoDiv.className = 'mb-4';
                            videoDiv.innerHTML = `
                                <video width="100%" autoplay muted playsinline loop class="rounded-lg shadow-lg">
                                    <source src="VideoBMMonforte.mp4" type="video/mp4">
                                    Tu navegador no soporta el elemento de video.
                                </video>
                            `;
                            infoColumn.appendChild(videoDiv);
                        } else if (centro.imagen) {
                            const imgDiv = document.createElement('div');
                            imgDiv.className = 'mb-4';
                            imgDiv.innerHTML = `
                                <img src="${centro.imagen}" alt="${centro.nombre_centro}" class="w-full rounded-lg shadow-lg">
                            `;
                            infoColumn.appendChild(imgDiv);
                        }

                        // Informaci√≥n b√°sica
                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'space-y-4';

                        // Crear el HTML con validaci√≥n de datos
                        let html = `
                            <div class="space-y-2">
                                <div class="flex items-center space-x-2 text-gray-700">
                                    <i class="fas fa-map-marker-alt text-green-500"></i>
                                    <h3 class="text-lg font-semibold">Direcci√≥n</h3>
                                </div>
                                <p class="text-gray-600">${centro.direccion || 'No disponible'}</p>
                            </div>
                        `;

                        // A√±adir secci√≥n de √°mbitos de mantenimiento si existe
                        if (centro.ambitos_mantenimiento && Array.isArray(centro.ambitos_mantenimiento) && centro.ambitos_mantenimiento.length > 0) {
                            html += `
                                <div class="space-y-2">
                                    <div class="flex items-center space-x-2 text-gray-700">
                                        <i class="fas fa-route text-green-500"></i>
                                        <h3 class="text-lg font-semibold">√Åmbitos de Mantenimiento</h3>
                                    </div>
                                    <ul class="list-disc list-inside text-gray-600">
                                        ${centro.ambitos_mantenimiento.map(ambito => `
                                            <li>${ambito}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            `;
                        }

                        html += `
                            <div class="space-y-2">
                                <div class="flex items-center space-x-2 text-gray-700">
                                    <i class="fas fa-directions text-green-500"></i>
                                    <h3 class="text-lg font-semibold">C√≥mo llegar</h3>
                                </div>
                                <div class="text-gray-600">
                                    ${centro.como_llegar || 'No disponible'}
                                </div>
                            </div>
                            <div class="space-y-2">
                                <div class="flex items-center space-x-2 text-gray-700">
                                    <i class="fas fa-map text-green-500"></i>
                                    <h3 class="text-lg font-semibold">Ubicaci√≥n</h3>
                                </div>
                                <div class="mt-2">
                                    <div class="iframe-container">
                                        ${centro.iframe.replace('height="300"', 'height="200"')}
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-6">
                                <!-- UTE Mantenimiento IyV -->
                                <div class="space-y-2">
                                    <div class="flex items-center space-x-2 text-gray-700">
                                        <i class="fas fa-building text-green-500"></i>
                                        <h3 class="text-lg font-semibold">6. UTE Mantenimiento IyV</h3>
                                    </div>
                                    <p class="text-gray-600 mb-2">
                                        ${['BM Villarrubia', 'BM Gabald√≥n'].includes(centro.nombre_centro) ? 'UTE BASES VILLARRUBIA-GABALD√ìN' : 'MANTENIMIENTO LAV ESTE UTE'}
                                    </p>
                                    <img src="${['BM Villarrubia', 'BM Gabald√≥n'].includes(centro.nombre_centro) ? 'img/uteacciona.png' : 'img/logo-ute-mantenimiento.jpg'}" 
                                         alt="${['BM Villarrubia', 'BM Gabald√≥n'].includes(centro.nombre_centro) ? 'Logo UTE BASES VILLARRUBIA-GABALD√ìN' : 'Logo UTE Mantenimiento IyV'}" 
                                         class="w-48 h-auto mt-2"
                                         onerror="this.style.display='none'">
                                </div>

                                <!-- UTE Mantenimiento Energ√≠a -->
                                <div class="space-y-2">
                                    <div class="flex items-center space-x-2 text-gray-700">
                                        <i class="fas fa-bolt text-yellow-500"></i>
                                        <h3 class="text-lg font-semibold">7. UTE Mantenimiento Energ√≠a</h3>
                                    </div>
                                    <p class="text-gray-600 mb-2">UTE MANTENIMIENTO AVE ENERGIA</p>
                                    <img src="img/uteenergia.png" alt="Logo UTE MANTENIMIENTO AVE ENERGIA" class="w-48 h-auto mt-2" onerror="this.style.display='none'">
                                </div>

                                ${centro.nombre_centro === 'BM Monforte' ? `
                                <!-- UTE Mantenimiento IISS/TELECO combinado para BM Monforte -->
                                <div class="space-y-2">
                                    <div class="flex items-center space-x-2 text-gray-700">
                                        <div class="flex space-x-1">
                                            <i class="fas fa-traffic-light text-blue-500"></i>
                                            <i class="fas fa-satellite-dish text-purple-500 ml-1"></i>
                                        </div>
                                        <h3 class="text-lg font-semibold">8. UTE Mantenimiento IISS/TELECO</h3>
                                    </div>
                                    <p class="text-gray-600 mb-2">UTE SALAVE</p>
                                    <img src="img/utesalave.png" 
                                         alt="Logo UTE SALAVE" 
                                         class="w-48 h-auto mt-2"
                                         onerror="this.style.display='none'">
                                </div>` : `
                                <!-- UTE Mantenimiento IISS para otras BM -->
                                <div class="space-y-2">
                                    <div class="flex items-center space-x-2 text-gray-700">
                                        <i class="fas fa-traffic-light text-blue-500"></i>
                                        <h3 class="text-lg font-semibold">8. UTE Mantenimiento IISS</h3>
                                    </div>
                                    <p class="text-gray-600 mb-2">
                                        ${['BM Villarrubia', 'BM Requena'].includes(centro.nombre_centro) ? 'UTE MALEV' : 'MANTENIMIENTO DE INSTALACIONES DE SEGURIDAD'}
                                    </p>
                                    <img src="${['BM Villarrubia', 'BM Requena'].includes(centro.nombre_centro) ? 'img/utemalev.png' : 'img/logo-ute-iiss.jpg'}" 
                                         alt="${['BM Villarrubia', 'BM Requena'].includes(centro.nombre_centro) ? 'Logo UTE MALEV' : 'Logo UTE IISS'}" 
                                         class="w-24 h-auto mt-2" 
                                         onerror="this.style.display='none'">
                                </div>

                                <!-- UTE Mantenimiento TELECO para otras BM -->
                                <div class="space-y-2">
                                    <div class="flex items-center space-x-2 text-gray-700">
                                        <i class="fas fa-satellite-dish text-purple-500"></i>
                                        <h3 class="text-lg font-semibold">9. UTE Mantenimiento TELECO</h3>
                                    </div>
                                    <p class="text-gray-600 mb-2">
                                        ${['BM Villarrubia', 'BM Requena'].includes(centro.nombre_centro) ? 'HITACHI' : 'MANTENIMIENTO DE TELECOMUNICACIONES'}
                                    </p>
                                    <img src="${['BM Villarrubia', 'BM Requena'].includes(centro.nombre_centro) ? 'img/hitachi.png' : 'img/logo-ute-teleco.jpg'}" 
                                         alt="${['BM Villarrubia', 'BM Requena'].includes(centro.nombre_centro) ? 'Logo HITACHI' : 'Logo UTE TELECO'}" 
                                         class="w-48 h-auto mt-2" 
                                         onerror="this.style.display='none'">
                                </div>`}
                            </div>
                       `;

                        // La secci√≥n de √°mbitos de mantenimiento se ha movido arriba, junto con el HTML principal

                        infoDiv.innerHTML = html;
                        infoColumn.appendChild(infoDiv);

                        // Columna derecha: Personal
                        const personalColumn = document.createElement('div');
                        personalColumn.className = 'w-full md:w-1/2 space-y-6'; // A√±adido espacio vertical entre elementos

                        // Ordenar los cargos en BM seg√∫n la jerarqu√≠a
                        const ordenBM = [
                            'Jefe de Base',
                            'C.T. Ingenier√≠a Civil',
                            'Jefe de Unidad',
                            'T√©cnico De Infra y V√≠a',
                            'T√©cnico Proyectos y Explanaciones', // A√±adido puesto de proyectos
                            'T√©cnico De Inversiones', // A√±adido puesto de inversiones
                            'T√©cnico Documentalista' // A√±adido puesto de documentalista
                        ];

                        // Crear un nuevo array ordenado
                        const ordenado = [];
                        
                        // A√±adir los cargos en el orden especificado
                        ordenBM.forEach(cargo => {
                            if (personasPorPuesto[cargo]) {
                                ordenado.push({
                                    cargo: cargo,
                                    personas: personasPorPuesto[cargo]
                                });
                                delete personasPorPuesto[cargo];
                            }
                        });
                        
                        // A√±adir el resto de cargos en orden alfab√©tico
                        Object.keys(personasPorPuesto).sort().forEach(cargo => {
                            ordenado.push({
                                cargo: cargo,
                                personas: personasPorPuesto[cargo]
                            });
                        });

                        console.log('Array ordenado (BM):', ordenado); // Log para depuraci√≥n
                        // Mostrar cada puesto con sus nombres usando el array ordenado
                        ordenado.forEach(item => {
                            const puestoDiv = document.createElement('div');
                            puestoDiv.className = 'puesto-item mb-4';
                            
                            let html = `
                                <div class="puesto-header mb-2">
                                    <span class="text-lg font-semibold text-gray-700">${item.cargo}</span>
                                </div>
                                <div class="nombres-list">
                                    ${item.personas.map(persona => {
                                        if (!persona || !persona.nombre) {
                                            return ''; // No generar HTML si falta el objeto persona o el nombre
                                        }
                                        const empresa = persona.correo && persona.correo.includes('@adif.es') ? 'adif' : 'ineco';
                                        return `
                                            <div class="nombre-item mb-1">
                                                <div class="persona-icon ${empresa}">
                                                    <i class="fas fa-user"></i>
                                                </div>
                                                <span class="text-gray-600">${persona.nombre}</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `;

                            puestoDiv.innerHTML = html;
                            personalColumn.appendChild(puestoDiv);
                        });

                        container.appendChild(infoColumn);
                        container.appendChild(personalColumn);
                        modalContent.appendChild(container);
                    } else {
                        // Crear la estructura de una columna para oficinas
                        const container = document.createElement('div');
                        container.className = 'space-y-6 office-modal-content'; // A√±adida nueva clase

                        console.log('Personas agrupadas por puesto (oficina):', personasPorPuesto); // Log para depuraci√≥n
                        // Mostrar cada puesto con sus nombres
                        Object.keys(personasPorPuesto).sort().forEach(puesto => {
                            const puestoDiv = document.createElement('div');
                            puestoDiv.className = 'puesto-item mb-4';
                            
                            let html = `
                                <div class="puesto-header mb-2">
                                    <span class="text-lg font-semibold text-gray-700">${puesto}</span>
                                </div>
                                <div class="nombres-list">
                                    ${personasPorPuesto[puesto].map(persona => {
                                         if (!persona || !persona.nombre) {
                                            return ''; // No generar HTML si falta el objeto persona o el nombre
                                        }
                                        const empresa = persona.correo && persona.correo.includes('@adif.es') ? 'adif' : 'ineco';
                                        return `
                                            <div class="nombre-item mb-1">
                                                <div class="persona-icon ${empresa}">
                                                    <i class="fas fa-user"></i>
                                                </div>
                                                <span class="text-gray-600">${persona.nombre}</span>
                                                </div>
                                            `;
                                        }).join('')}
                                   </div>
                               `;

                            puestoDiv.innerHTML = html;
                            container.appendChild(puestoDiv);
                        });

                        modalContent.appendChild(container);
                    }
                    
                    modal.classList.add('active');
                }

                // Funci√≥n para cerrar el modal
                function closeModal() {
                    modal.classList.remove('active');
                }

                // Event listeners
                closeModalBtn.addEventListener('click', closeModal);
                
                // Cerrar modal al hacer clic fuera del contenido
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
                
                // Cerrar modal con tecla ESC
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && modal.classList.contains('active')) {
                        closeModal();
                    }
                });
            })
            .catch(error => {
                console.error('Error loading map data:', error);
            });
    </script>
</body>
</html>